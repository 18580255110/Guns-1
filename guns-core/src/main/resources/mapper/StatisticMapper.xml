<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.stylefeng.guns.modular.system.dao.StatisticMapper">

    <resultMap id="StudentSignResultMap" type="java.util.HashMap">
        <result column="student_code" property="studentCode" />
        <result column="student_name" property="studentName" />
        <result column="class_code" property="classCode" />
        <result column="class_name" property="className" />
        <result column="teacher_name" property="teacherName" />
        <result column="sign_date" property="signDate" />
        <result column="desc" property="desc" />
        <result column="amount" property="amount" />
        <result column="pay_method" property="payMethod" />
        <result column="member_mobile" property="memberMobile" />
        <result column="order_no" property="orderNo" />

    </resultMap>

    <select id="statisticStudentSign" resultMap="StudentSignResultMap" parameterType="java.util.HashMap">
        select
         s.code as student_code, s.name as student_name, c.code as class_code, c.name as class_name,
         o.accept_date as sign_date, o.`desc` ,o.amount,o.pay_method,
         m.mobile_number as member_mobile, o.accept_no as order_no, c.teacher
        from
        (
        (
        (
        (
        (
        (
        tb_student_class sc
        join tb_student s on sc.student_code = s.code)
        join tb_member m on s.user_name = m.user_name)
        join tb_class c on sc.class_code = c.code)
        join tb_order o on sc.order_no = o.accept_no
          <if test="orderStatus != 2 ">
              and o.status = 1)
          </if>
          <if test="orderStatus == 2">
              and o.status = 2)
          </if>
        join tb_course co on c.course_code = co.code)
        )
        <where>
            <if test="orderStatus == 2">
                and sc.status = 0 AND sc.remark LIKE '%已退费%'
            </if>
            <if test="orderStatus != 2">
                and sc.status = 1
            </if>

            <if test="null != student">
                and ( s.code = #{student} or s.name LIKE CONCAT('%',#{student},'%') )
            </if>
            <!-- 班级信息 -->
            <if test="null != classInfo">
              and ( c.code = #{classInfo} or c.name LIKE CONCAT('%', #{classInfo}, '%') )
            </if>
            <!-- 老师 -->
            <if test="null != teacher">
                and
                (c.teacher_code = #{teacher}
                or c.teacher like CONCAT('%',#{teacher},'%')
                or c.teacher_second_code = #{teacher}
                or c.teacher_second like CONCAT('%',#{teacher},'%')
                )
            </if>
            <!-- 学科 -->
            <if test="null != subject">
                and co.subject = #{subject}
            </if>
            <!-- 班次 -->
            <if test="null != ability">
                and c.ability = #{ability}
            </if>
            <!-- 学期 -->
            <if test="null != cycle">
                and c.cycle = #{cycle}
            </if>
            <!-- 年级 -->
            <if test="null != grade">
                and c.grade = #{grade}
            </if>
        </where>
        order by o.accept_date desc
    </select>

</mapper>
